<div dir="rtl">

# تقرير الربع ثغرات امنية

السلام عليكم ورحمة الله وبركاته 

في هذا التقرير سوف أتكلّم عن أهم جزء يحدث من ثغرات المواقع عادةً الا وهو مدخلات المستخدم بمعنى أوضح المستخدم ما الذي يرسله لك وكيف تتعامل مع رسالته من النظرة المبدئية قد يبدو الموضوع بسيط لكن الموضوع اخطر مما تتوقع اعطيك مثال لكي تتضح لك الصورة 

توجد صفحة تسجيل دخول تتطلب عنصرين للدخول الى صلاحيات الحساب أو عنصر هو العنصر الفريد الذي يميز المستخدم مثل (الهوية الوطنية , اسم مميز , اي شيء لايمكن ان يتكرر) و كلمة المرور التي تسمح لك بدخول لصلاحيات المستخدم هذا الجزء الظاهر للمستخدم اما الجزء المخفي فهوا المنطقة الخطِرة هي التي تعطي الموافقة او الرفض طيب لو كانت عملية التحقق كانت بسيطة تاخذ قيم المستخدم وتقارنها مع القيم الموجودة في قاعدة البيانات بشكل ما تشوف شيء خطير  لكن الذي ما تشوفه هو انه ممكن تتم عليه تجاوز التحقق او تكون أسوأ مثل جلب معلومات غير مرغوب ظهورها وامثلتها كثير 

هذا يعتبر مثال بسيط نوعا ما اما في حالات اخر مثل الاعتماد على البيانات التي ترسل للمستخدم بعد تسجيل الدخول وتسمى معرفات الارتباط (الكوكيز) وهذه المعرفات وظيفتها تذكير الموقع هوية المستخدم وصلاحياته وبامكان المستخدم تغييرها بسهولة هذا نقطة خطيره وسوف اتطرق لها لاحقًا 

الان أخذنا أمثلة عن المشاكل الممكن تصير بسبب اعتمادا على مدخلات المستخدم فالآن ببني موقع بسيط عن مكتبة رقمية يتم حجز الكتب من خلالها فقط موقع بسيط وفكرة ابسط وعندنا نوعين من المستخدمين أولًا المستفيد من الكتب وثانيًا مسؤول المكتبة وهو ينظم الحجوزات لكل المستخدمين ويمكن اي شخص الاطلاع على الكتب ولا يستطيع ان يحجز الا من له حساب ويمكن لاي شخص الاطلاع على حجزاته فقط ويمكن انشاء حساب عادي وتسجيل الدخول طبيعي هذا بشكل عام وظائف الموقع 

عندنا الان اربع ثغرات بشرحها مع تطبيق عملي على كل وحدة من موقع المكتبة الرقمية هي كل الآتي

---
<br>
<br>

1. Authentication system flaw

2. SQL injection vulnerability

3. Cross-Site Scripting (XSS) vulnerability

4. Cookie manipulation

<br>
<br>

---

## 1. Authentication system flaw


أولًا ثغرة هي تجاوز عملية التحقق قبل ما ندخل في الثغرة بشرح مفهوم المصادقة وهي عملية التأكد من الشخص لها عدد من الطرق واشهرها هي عن طريق اسم المستخدم وكلمة المرور (وهي المطبقة في التطبيق ) و استخدام العلامات الحيوية ( مثل بصمة الوجه وغيره) وفي طريقة أخرى باستخدام مكالمة هاتفية وغيرها الكثير ويتم التحقق من المعلومات من قاعدة بيانات المستخدمين 

ولاستغلال عملية المصادقة أو كسرها يوجد الكثير من الطرق ومنها القوة الغاشمة (اختيار اسم مستخدم وتجربة الكثير من كلمات المرور ) وايضا التنصت على بروتوكول http وايضا عن طريق حقن اوامر sql وهي التي سوف نستخدمها في ذي الثغرة ويوجد طرق غيرها 

اما لعملية الاستغلال عن طرق حقن اوامر sql <br>في البداية  ندخل على الصفحة الرئيسية ونبحث عن صفحة تسجيل الدخول 

![صوره توضح المقصود](photo/the%201.png)

الان نحقن الامر <br> `– OR 1=1 ` <br> هذا الامر مهمته هي تجاوز عملية تحقق من كلمة المرور فلابد نكون عارفين اسم احد المستخدمين واشهر مستخدم هو admin وفي خانة كلمة المرور اي شيء لانه سوف نتخطّاها 


![صوره توضح المقصود](photo/the%202.png)


والان انا في حساب الأدمن (مسؤول النظام) عندي كل صلاحياته 


سبب حدوث هذا الثغرة هي ان لا يوجد تصفية لمدخلات المستخدم وعدم استعمال prepare statement <br> خصوصًا في ذا الكود <br> ```    const TheRseultFROMsql = db.prepare(`SELECT * FROM users WHERE username = '${req.body.username}' AND password_hash = '${req.body.password}' `).get() ```


والحل استعمال هذا الكود <br>
``` const sqlStatmentToGetINFO = db.prepare("SELECT * FROM users WHERE username = ?") ```
 ``` const TheRseultFROMsql = sqlStatmentToGetINFO.get(req.body.username) ```

وبعده يتم التحقق من كلمة المرور لحالها 


خلاصة الحماية من الثغرة توزيع عمليات التحقق والتأكد من مدخلات المستخدم ان تكون خالية من اي أكواد تحكم 

## 2. SQL injection vulnerability


ثانيا حقن اوامر sql في الاول ما هي sql هي لغة استعلامات لقواعد البيانات يمكن من ذي اللغة بناء جداول حذف جداول تعديل جداول واضافة بيانات حذف بيانات وكذلك تعديل بيانات ويمكنها عرض البيانات 

والان عملية الاستغلال تعتمد على حسب نوع المتغير اذا كان عدد او نص وقيمة منطقية (صح او خطأ) هذا القيم التي ترسل الى الاستعلام ولكي تستغل هذا الخطوة لابد نرسل الاوامر خارج المتغير في المتغيرات النصية تتم عن طريق اضافة فاصلة راسية ( ‘ ) وفي الارقام تتم عن طريق اضافة مسافة 


في التطبيق الذي طورتها أستغل الثغرة في نقطة بسيطة وهي جلب كل الحجوزات لجميع الاشخاص بدون استخدام صلاحيات الأدمن (المسؤول) 

أولًا ندخل على صفحة الكتب لان فيها خانة بحث نحاول نتوقع اسم الجدول 

واتضح اسم الجدول هو reservations <br> الان نحقن الاستعلام ذا 

` A' AND 1=0 UNION SELECT NULL AS A , NULL AS c, NULL AS f  , * FROM reservations -- `


![صوره توضح المقصود](photo/the%203.png)



![صوره توضح المقصود](photo/the%204.png)


وهذا هو الرد وكما تلاحظ جميع بيانات جدول الحجوزات أصبحت بيدي من تواريخ ومن الحالة والكمية ومعرف صاحب الطلب


في هذا الثغرة استغل المهاجم عمليات استعلام sql بسبب عدم تصفية المدخلات وتنفيذها مباشرة 

``` const sqlstatment_return_info_of_book = db.prepare(`SELECT * FROM books WHERE title LIKE '%${req.params.query}%'`).all() ```

والحل أولًا استخدام كود لتصفية المدخلات واستخدام prepare statement  وعدم ارسال المتغيرات مباشرة 

```     if (typeof req.params.query !== "string") req.params.query = ""
    req.params.query = sanitizeHTML(req.params.query.trim() , {allowedTags: [] , allowedAttributes: {}} )
    if (!req.params.query) errors.push("you must add query ")

    const sqlstatment_return_info_of_book = db.prepare("SELECT * FROM books WHERE title LIKE ?")
    const result_theinfo_of_book = sqlstatment_return_info_of_book.all(`%${req.params.query}%`)
    if(!result_theinfo_of_book)errors.push("not found the book")
 ```


## 3. Cross-Site Scripting (XSS) vulnerability


ثالثا ثغرة XSS هي عبارة عن حقن سكربتات خبيثة (مثل JavaScript) تُنفَّذ في متصفح الضحية ولها ثلاث انواع اساسية وهي المخزنة والمنعكسة و DOM-based اما في ذا التقرير سأتكلم عن المنعكسة لسرعتها ووضوحها وهي حقن أكواد جافا سكريبت ويتم عرضها على طول 

اما الان بطبق عملية استغلال بسيطة جدا وهي عرض تنبيه على الشاشة وهي دليل قاطع على وجود الثغرة الهدف تنفيذ امر alert بس أولًا لابد إيجاد حقل في التطبيق يمكنني من خلاله ارسال اي قيمة طبيعية وبعدها تطبيق على الصفحة مثل اسم او عملية بحث وسوف نلقي المطلوب في صفحة الكتب 


![صوره توضح المقصود](photo/the%205.png)



![صوره توضح المقصود](photo/the%206.png)



الان وجدت افضل مكان للتأكد من وجود الثغرة بعدها نحقن هذا الامر 

`p' -- "<img src="x" onerror="alert('Adel almquti')"> `

بعدها اضغط على زر البحث 


![صوره توضح المقصود](photo/the%207.png)



هذا دليل قوي على وجود الثغرة وسبب حدوثها له اكثر من طريق في طرق تكون بسبب back end وفي سبب اخر يعود على front end اما بالنسبة لمشكلة الموقع فهي بسبب الجزئين كيف؟ <br> انا اقولك لان الموقع ياخذ المدخلات ويرسلها الى السيرفر والسيرفر يرجع المدخلات والنتائج والذي يعرض فقط الذي ارسله السيرفر 



ويوجد مواقع تعرض المدخلات على طول بدون ما ترجع من السيرفر وهذا غير مستحب أمنيًا


اذا لإغلاق هذا الثغرة التي في موقعي أولًا تصفية وتنقيح المدخلات من اي سكريبتات او أكواد خبيثة وعمل ترميز للمخرجات <br>وافضل طريقة هي استعمال هذا الكود 


```
    if (typeof req.params.query !== "string") req.params.query = ""
    req.params.query = sanitizeHTML(req.params.query.trim() , {allowedTags: [] , allowedAttributes: {}} )
```
 
## 4. Cookie manipulation


اخر ثغره هي التلاعب بملفات الارتباط (الكوكيز) قبل ما اوضح الثغرة بشرح ما هو الكوكيز وماهي فائدة الكوكيز هي بيانات تعطى تلقائيا للمستخدمين وهي معلومات تميز كل مستخدم وتحتوي على معلومات خاصة للمستخدم مثل المعرف (ID) واشياء اخرى ومن أهم فائدة لها ان الموقع لا ينسى المستخدم بمعنى اذا سجل خروجه المستخدم بياناته المؤقت لا تنحذف اذا سجل دخوله مره اخرى مثل عناصر العربة وغيرها 

اما بالنسبة للثغره فهي تركز على تغير البيانات الحساسة او سرقة الكوكيز كاملة من اشخاص مهمين (مثل مسؤول النظام)  وعملية التغير تركز على المتغيرات المهم مثل ( is_admin , ID , userName وغيرها ) 

لتطبيقها على الموقع افتح برنامج burp suite  وننتقل لطلب تسجيل الدخول 


![صوره توضح المقصود](photo/the%208.png)



![صوره توضح المقصود](photo/the%209.png)



بعد عملية الدخول نلاحظ قيمة الكوكيز وفيها قيم حساسه واولها userid من كثر ما هو واضح ما يحتاج له فك ترميز حتى 


![صوره توضح المقصود](photo/the%2010.png)



الان فقط نغير قيمة userid ونضعها بصفر وسوف تجيني جميع صلاحيات الأدمن وهذا بسبب الاعتماد على قيم الكوكيز وفي الاصل هذا يعتبر قيمة من المستخدم اذا يجب الا تعتمد على هذا القيم ابدا 


![صوره توضح المقصود](photo/the%2011.png)



السبب الرئيسي لهذه المشكلة لم يتم عمل توقيع  للكوكيز  ( التوقيع يعني ان القيم في الكوكيز لن تتغير الا من السيرفر فقط ) ولتوقيع خطوات بسيطة وهي استخدام JWT وهذا هو الكود المخصص لحل ذي الثغرة ومن المهم التأكد من القيم من جهت السيرفر وعدم الاعتماد على الكوكيز ابدا في البيانات الحساسة 

```
    const bigValueToken = jwt.sign( {exp: Math.floor(Date.now() / 1000) + 60 * 24 * 60 ,userid: user.id , username: user.username} , process.env.JWTSSS)
    
    res.cookie("webisTheBest" , bigValueToken , {
        httpOnly: true,
        secure: true,
        sameSite: "strict" ,// defunce with CSRF attack
        maxAge: 1000 * 60 * 60 *24
    })
```

بالنسبة لارسال الكوكيز لها عدد من القيم اولها httpOnly: true يحمي من سرقة الكوكيز عبر ثغره xss <br> secure: true الكوكيز ترسل فقط اذا استخدمة بروتوكول https <br> sameSite: "strict" يحمي من ثغرة لم اطرق اليها في هذا التقرير وهي CSRF <br> maxAge يحدد عمر للكوكيز


</div>