<!DOCTYPE html>
<html  lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Library</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div class="header">
        <h1>ðŸ“š Library Admin Panel</h1>
        <nav>
            <a href="/">Home</a>
            <a href="/books">Books</a>
            <a href="/my-reservations">My Reservations</a>
            <a href="/admin">Admin Panel</a>
            <a href="/logout" style="background: #f44336; color: white;">Logout</a>
        </nav>
    </div>

    <div class="container">
        <!-- Tabs -->
        <div class="card">
            <div style="display: flex; gap: 1rem; border-bottom: 2px solid #e0e0e0; padding-bottom: 1rem;">
                <button class="btn btn-primary" onclick="showTab('books')">Manage Books</button>
                <button class="btn btn-secondary" onclick="showTab('reservations')">Manage Reservations</button>
            </div>
        </div>

        <!-- Tab: Books Management -->
        <div id="booksTab" class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                <h2>Manage Books</h2>
                <button class="btn btn-success" onclick="showAddBookModal()">+ Add New Book</button>
            </div>

            <div id="booksLoading" class="loading">Loading books...</div>
            
            <div id="booksTable" style="display: none;">
                <table class="table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Title</th>
                            <th>Author</th>
                            <th>ISBN</th>
                            <th>Quantity</th>
                            <th>Available</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="booksBody"></tbody>
                </table>
            </div>
        </div>

        <!-- Tab: Reservations Management -->
        <div id="reservationsTab" class="card" style="display: none;">
            <h2>Manage Reservations</h2>
            <p style="color: #666; margin-bottom: 2rem;">Review and approve or reject book reservation requests</p>

            <div id="reservationsLoading" class="loading">Loading reservations...</div>
            
            <div id="reservationsTable" style="display: none;">
                <table class="table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>User</th>
                            <th>Book</th>
                            <th>Reservation Date</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="reservationsBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal: Add/Edit Book -->
    <div id="bookModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="bookModalTitle">Add New Book</h2>
                <button class="modal-close" onclick="closeBookModal()">&times;</button>
            </div>
            <form id="bookForm">
                <input type="hidden" id="bookId">
                
                <div class="form-group">
                    <label for="title">Book Title *</label>
                    <input type="text" id="title" required maxlength="200">
                </div>

                <div class="form-group">
                    <label for="author">Author *</label>
                    <input type="text" id="author" required maxlength="100">
                </div>

                <div class="form-group">
                    <label for="isbn">ISBN Number *</label>
                    <input type="text" id="isbn" required maxlength="20">
                </div>

                <div class="form-group">
                    <label for="description">Description</label>
                    <textarea id="description" rows="4" maxlength="2000"></textarea>
                </div>

                <div class="form-group">
                    <label for="quantity">Quantity *</label>
                    <input type="number" id="quantity" required min="0">
                </div>

                <div class="form-group">
                    <label for="image_url">Image URL</label>
                    <input type="url" id="image_url" maxlength="255" placeholder="https://...">
                </div>

                <div style="display: flex; gap: 1rem;">
                    <button type="submit" class="btn btn-success" style="flex: 1;">Save</button>
                    <button type="button" class="btn btn-secondary" onclick="closeBookModal()" style="flex: 1;">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: Update Quantity -->
    <div id="quantityModal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h2>Update Available Quantity</h2>
                <button class="modal-close" onclick="closeQuantityModal()">&times;</button>
            </div>
            <form id="quantityForm">
                <input type="hidden" id="quantityBookId">
                
                <div class="form-group">
                    <label for="newQuantity">New Quantity *</label>
                    <input type="number" id="newQuantity" required min="0">
                    <small style="color: #666;">Current quantity: <span id="currentQuantity"></span></small>
                </div>

                <div style="display: flex; gap: 1rem;">
                    <button type="submit" class="btn btn-primary" style="flex: 1;">Update</button>
                    <button type="button" class="btn btn-secondary" onclick="closeQuantityModal()" style="flex: 1;">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: Update Reservation -->
    <div id="reservationModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2>Update Reservation Status</h2>
                <button class="modal-close" onclick="closeReservationModal()">&times;</button>
            </div>
            <form id="reservationForm">
                <input type="hidden" id="reservationId">
                
                <div class="form-group">
                    <label for="status">Status *</label>
                    <select id="status" size="2" required>
                        <option value="approved" selected>Approve</option>
                        <option value="rejected">Reject</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="admin_notes">Admin Notes</label>
                    <textarea id="admin_notes" rows="3" maxlength="500"></textarea>
                </div>

                <div style="display: flex; gap: 1rem;">
                    <button type="submit" class="btn btn-primary" style="flex: 1;">Save</button>
                    <button type="button" class="btn btn-secondary" onclick="closeReservationModal()" style="flex: 1;">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <script src="js/config.js"></script>
    <script>
        // Check admin permissions
        async function x(){
            const response = await fetch("/Who_I_am" )
            const response2 = await fetch("/IS_I_am_Good" )
            const data2 = await response2.json();
            const data = await response.json();
            if (!data.IS || !data2.IS ) {
                showMessage('Unauthorized. Admin access required', 'error');
                setTimeout(() => window.location.href = '/', 1500);
            }
        }
        x()
        let currentTab = 'books';
        let editingBookId = null;

        // Switch between tabs
        function showTab(tab) {
            currentTab = tab;
            document.getElementById('booksTab').style.display = tab === 'books' ? 'block' : 'none';
            document.getElementById('reservationsTab').style.display = tab === 'reservations' ? 'block' : 'none';
            
            if (tab === 'books') {
                loadBooks();
            } else {
                loadReservations();
            }
        }

        // ==== Books Management ====

        async function loadBooks() {
            document.getElementById('booksLoading').style.display = 'block';
            document.getElementById('booksTable').style.display = 'none';
            
            try {
                const response = await fetch("/get_all_book") 
                const data = await response.json()
                displayBooks(data.data.books);
            } catch (error) {
                showMessage('Book loading failed', 'error');
                document.getElementById('booksLoading').style.display = 'none';
            }
        }

        function displayBooks(books) {
            document.getElementById('booksLoading').style.display = 'none';
            document.getElementById('booksTable').style.display = 'block';
            
            const tbody = document.getElementById('booksBody');
            tbody.innerHTML = books.map((book, index) => `
                <tr>
                    <td>${index + 1}</td>
                    <td>${book.title}</td>
                    <td>${book.author}</td>
                    <td>${book.isbn}</td>
                    <td>${book.quantity}</td>
                    <td>${book.available_quantity}</td>
                    <td>
                        <button class="btn btn-primary" onclick="showEditBookModal(${book.id})" style="padding: 6px 12px; font-size: 0.85rem; margin: 2px;">Edit</button>
                        <button class="btn btn-secondary" onclick="showQuantityModal(${book.id}, ${book.quantity})" style="padding: 6px 12px; font-size: 0.85rem; margin: 2px;">Quantity</button>
                        <button class="btn btn-danger" onclick="deleteBook(${book.id})" style="padding: 6px 12px; font-size: 0.85rem; margin: 2px;">Delete</button>
                    </td>
                </tr>
            `).join('');
        }

        function showAddBookModal() {
            editingBookId = null;
            document.getElementById('bookModalTitle').textContent = 'Add New Book';
            document.getElementById('bookForm').reset();
            document.getElementById('bookId').value = '';
            document.getElementById('bookModal').classList.add('active');
        }

        async function showEditBookModal(bookId) {
            editingBookId = bookId;
            document.getElementById('bookModalTitle').textContent = 'Edit Book';
            try {
                

                const response = await fetch(`/getbookbyID${bookId}`)
                const data = await response.json()
                const book = data.data;
                
                document.getElementById('bookId').value = book.id;
                document.getElementById('title').value = book.title;
                document.getElementById('author').value = book.author;
                document.getElementById('isbn').value = book.isbn;
                document.getElementById('description').value = book.description || '';
                document.getElementById('quantity').value = book.available_quantity;
                document.getElementById('image_url').value = book.image_url || '';
                
                document.getElementById('bookModal').classList.add('active');
            } catch (error) {
                showMessage('Failed to load book data', 'error');
            }
        }

        function closeBookModal() {
            document.getElementById('bookModal').classList.remove('active');
        }

        document.getElementById('bookForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const bookData = {
                title: document.getElementById('title').value,
                author: document.getElementById('author').value,
                isbn: document.getElementById('isbn').value,
                description: document.getElementById('description').value,
                quantity: parseInt(document.getElementById('quantity').value),
                image_url: document.getElementById('image_url').value || null
            };
            
            const submitBtn = e.target.querySelector('button[type="submit"]');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Saving...';
            
            try {
                
                if (editingBookId) {
                    const result = await fetch(`/update_book${editingBookId}` , {
                        method: "POST",
                        headers: { "Content-Type": "application/json"},
                        body: JSON.stringify(bookData)
                    })
                    const data = await result.json()
                    if (!result.ok) {
                        // show errors
                        data.errors.forEach(err => showMessage(err, "error"));
                        return;
                    }
                    showMessage('Book updated successfully', 'success');
                } else {
                    const result = await fetch("/create_book" , {
                        method: "POST",
                        headers: { "Content-Type": "application/json"},
                        body: JSON.stringify(bookData)
                    })
                    const data = await result.json()
                    if (!result.ok) {
                        // show errors
                        data.errors.forEach(err => showMessage(err, "error"));
                        return;
                    }
                    showMessage('Book added successfully', 'success');
                }
                
                closeBookModal();
                loadBooks();
            } catch (error) {
                showMessage(error.message || 'Failed to save book', 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Save';
            }
        });

        function showQuantityModal(bookId, currentQty) {
            document.getElementById('quantityBookId').value = bookId;
            document.getElementById('currentQuantity').textContent = currentQty;
            document.getElementById('newQuantity').value = currentQty;
            document.getElementById('quantityModal').classList.add('active');
        }

        function closeQuantityModal() {
            document.getElementById('quantityModal').classList.remove('active');
        }

        document.getElementById('quantityForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const bookId = document.getElementById('quantityBookId').value;
            const newQuantity = parseInt(document.getElementById('newQuantity').value);
            
            try {
                const result = await fetch(`/update_value${bookId}` , {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ newQuantity })
                })
                const data = await result.json()
                if (!result.ok) {
                    // show errors
                    data.errors.forEach(err => showMessage(err, "error"));
                    return;
                } 
                showMessage('Quantity updated successfully', 'success');
                closeQuantityModal();
                loadBooks();
            } catch (error) {
                showMessage(error.message || 'Failed to update quantity', 'error');
            }
        });

        async function deleteBook(bookId) {
            if (!confirm('Are you sure you want to delete this book?')) {
                return;
            }
            
            try {
                const result = await fetch(`/delete_book${bookId}`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" }
                })
                const data = await result.json()
                if (!result.ok) {
                    // show errors
                    data.errors.forEach(err => showMessage(err, "error"));
                    return;
                }
                showMessage('Book deleted successfully', 'success');
                loadBooks();
            } catch (error) {
                showMessage(error.message || 'Failed to delete book', 'error');
            }
        }

        // ==== Reservations Management ====

        async function loadReservations() {
            document.getElementById('reservationsLoading').style.display = 'block';
            document.getElementById('reservationsTable').style.display = 'none';
            
            try {
                
                const response = await fetch("/get_all_reservations")
                const x = await response.json()
                displayReservations(x.data.reservations);
            } catch (error) {
                showMessage('Failed to load reservations', 'error');
                document.getElementById('reservationsLoading').style.display = 'none';
            }
        }

        function displayReservations(reservations) {
            document.getElementById('reservationsLoading').style.display = 'none';
            document.getElementById('reservationsTable').style.display = 'block';
            
            const tbody = document.getElementById('reservationsBody');
            tbody.innerHTML = reservations.map((res, index) => `
                <tr>
                    <td>${index + 1}</td>
                    <td>${res.full_name} (${res.username})</td>
                    <td>${res.title}</td>
                    <td>${new Date(res.reservation_date).toLocaleDateString('ar-EG')}</td>
                    <td>
                        <span class="status ${res.status}">
                            ${getStatusText(res.status)}
                        </span>
                    </td>
                    <td>
                        ${res.status === 'pending' ? `
                            <button class="btn btn-primary" onclick="showReservationModal(${res.id})" style="padding: 6px 12px; font-size: 0.9rem;">
                                Process
                            </button>
                        ` : '-'}
                    </td>
                </tr>
            `).join('');
        }

        function getStatusText(status) {
            const statusMap = {
                'pending': 'Pending',
                'approved': 'Approved',
                'rejected': 'Rejected',
                'cancelled': 'Cancelled'
            };
            return statusMap[status] || status;
        }

        function showReservationModal(reservationId) {
            document.getElementById('reservationId').value = reservationId;
            document.getElementById('status').value = 'approved';
            document.getElementById('admin_notes').value = '';
            document.getElementById('reservationModal').classList.add('active');
        }

        function closeReservationModal() {
            document.getElementById('reservationModal').classList.remove('active');
        }

        document.getElementById('reservationForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const reservationId = document.getElementById('reservationId').value;
            const status = document.getElementById('status').value;
            const notes = document.getElementById('admin_notes').value;
            
            try {
                console.log(reservationId)
                const R = await fetch(`/update_reservations${reservationId}` , {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ status , notes })
                })
                const data = await R.json()
                if (!R.ok) {
                    // show errors
                    data.errors.forEach(err => showMessage(err, "error"));
                    return;
                }
                showMessage('Reservation updated successfully', 'success');
                closeReservationModal();
                loadReservations();
            } catch (error) {
                showMessage(error.message || 'Failed to update reservation', 'error');
            }
        });

        // Initial load
        loadBooks();
    </script>
</body>
</html>